<!DOCTYPE html>
<html>
  <head>
    <title>BogusApp: Mobile Camera</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        background-color: #f3f3f3;
      }

      #message {
        margin: auto;
        width: 90%;
        max-width: 500px;
        text-align: center;
        font-weight: 500;
        font-size: 4rem;
      }
    </style>
  </head>

  <body>
    <h1 id="message">logging you in from your camera...</h1>
    <script type="text/javascript">
      (() => {
        if (location.search.split("?qrCode=").length > 1) {
          const qrCode = location.search.split("?qrCode=")[1];
          requestQRCodeLogin(qrCode);
        }
      })();

      requestQRCodeLogin = qrCode => {
        const host = location.host;
        const isLocal = host.includes("localhost");
        const webSocketUri = `ws${isLocal ? "" : "s"}`;
        const url = `${webSocketUri}://${host}`;
        const connection = new WebSocket(url);

        connection.onopen = () => {
          const payload = {
            action: "validateQRCode",
            username: "Stranger from camera",
            qrCode
          };

          const payloadJSON = JSON.stringify(payload);
          connection.send(payloadJSON);
          console.log(`Send payload to websocket: ${payloadJSON}`);
        };

        connection.onerror = error => {
          console.log(`WebSocket error: ${error}`);
        };

        connection.onmessage = event => {
          console.log(`Receive message from websocket: ${event.data}`);

          const messageElement = document.getElementById("message");
          const response = JSON.parse(event.data);
          const { action } = response;

          switch (action) {
            case "verifiedAccount":
              const { username } = response;
              messageElement.innerText = `Woohoo ðŸŽ‰, hello ${username}!!!`;
              break;
            default:
              const { message } = response;
              console.log(message);
              messageElement.innerText = "Opps, there's an error. ðŸ˜³";
          }

          // There's no retrying for this page so we can close the connection
          connection.close();
        };

        connection.onclose = () => {
          console.log("WebSocket is closed.");
        };
      };
    </script>
  </body>
</html>
