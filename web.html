<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        margin: 0;
        display: flex;
        width: 100vw;
        height: 100vh;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-family: monospace;
      }

      h1 {
        margin-bottom: 4rem;
      }

      .qrCode {
        width: 300px;
        height: 300px;
      }

      #name {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1 id="name"></h1>
    <div id="scan">
      <h1>Scan QR Code to login</h1>
      <div class="qrCode">
        <canvas id="qrCode"></canvas>
      </div>
    </div>

    <script src="./static/qrious.min.js"></script>
    <script>
      const url = "wss://bogusapp.herokuapp.com";
      const connection = new WebSocket(url);

      connection.onopen = () => {
        const payload = {
          action: "get_qr_code"
        };

        const payloadJSON = JSON.stringify(payload);
        connection.send(payloadJSON);
        console.log(`Send payload from websocket: ${payloadJSON}`);
      };

      connection.onerror = error => {
        console.log(`WebSocket error: ${error}`);
      };

      connection.onmessage = event => {
        console.log(`Receive data from websocket: ${event.data}`);

        const response = JSON.parse(event.data);
        const { action } = response;

        switch (action) {
          case "get_qr_code":
            const { qrCode } = response;
            showQrCode(qrCode);
            break;
          case "validated_qr_code":
            const { username } = response;
            loginUser(username);
            break;
          case "error":
          default:
            if (response.message) {
              alert(response.message);
            } else {
              alert("Something went wrong");
            }
        }
      };

      connection.onclose = () => {
        console.log("WebSocket is now closed.");
      };

      showQrCode = qrCode => {
        new QRious({
          element: document.getElementById("qrCode"),
          size: 300,
          value: qrCode
        });

        console.log(`HERE'S MY QR CODE: ${qrCode}`);
      };

      loginUser = username => {
        const scanElement = document.getElementById("scan");
        const nameElement = document.getElementById("name");

        scanElement.style.display = "none";
        nameElement.style.display = "block";
        nameElement.innerHTML = `Hello ${username}!`;

        // You can now close the websocket.
        connection.close();
      };
    </script>
  </body>
</html>
